@page "/products/{productName}/{featureName}/toggles/add"
@attribute [Authorize(Policies.Contributor)]
@layout MainLayout

@inject IEsquioHttpClient esquioHttpClient
@inject INotifications notifications
@inject EsquioState  esquioState
@inject NavigationManager navigation

@using ExcludedToggle = Esquio.UI.Api.Shared.Models.Features.Details.ToggleDetail

<PageTransition>
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <PageTitle Title="Toggle Detail"
                           Subtitle="Show the collection of available toggles.">
                    <Icon>
                        <i class="fas fa-toggle-on"></i>
                    </Icon>
                </PageTitle>
            </div>
        </div>
    </section>
    <section class="content toggle-detail">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12 col-lg-6">
                    <div class="row mb-4">
                        <div class="col-9">
                            <input type="text"
                                   class="form-control"
                                   placeholder="Search for a toggle..."
                                   @bind-value="ToggleSearch"
                                   @bind-value:event="oninput" />
                        </div>
                        <div class="col-3">
                            <button type="button"
                                    class="btn btn-primary btn-shadow"
                                    style="width: 100%;"
                                    disabled="@(!ToggleSearch.HasValue())"
                                    @onclick="@(() => { ToggleSearch = null;  })">
                                    Clear
                            </button>
                        </div>
                    </div>
                    <div class="card card-primary card-outline card-tabs">
                        <div class="card-header p-0 pt-1 border-bottom-0">
                            <ul class="nav nav-tabs" id="toggle-types-tab" role="tablist">
                                @if (assemblies != null)
                                {
                                    @foreach (var assembly in FilterAssemblies(assemblies))
                                    {
                                        <li class="nav-item">
                                            <a class="nav-link@(assembly == selectedAssembly ? " active" : "")"
                                               id="@assembly-tab"
                                               data-toggle="pill"
                                               href="#@assembly"
                                               role="tab"
                                               aria-controls="@assembly"
                                               aria-selected="@(assembly == selectedAssembly ? "true" : "false")"
                                               @onclick="@(() => SelectAssembly(assembly))">
                                                @assembly
                                            </a>
                                        </li>
                                    }
                                }
                            </ul>
                        </div>
                        <div class="card-body">
                            <div class="tab-content" id="toggle-types-tabContent">
                                @if (assemblies == null)
                                {
                                    <div class="tab-pane fade active show" role="tabpanel">
                                        <SkeletonCards Cols="3" />
                                    </div>
                                }
                                else
                                {
                                    @foreach (var assembly in FilterAssemblies(assemblies))
                                    {
                                        <div class="tab-pane fade@(assembly == selectedAssembly ? " active show" : "")"
                                             id="@assembly"
                                             role="tabpanel"
                                             aria-labelledby="@assembly-tab">
                                            <div class="form-group">
                                                <SingleCards Items="GetAssemblyToggles(assembly)">
                                                    <CardTitle Context="toggle">
                                                        @toggle.FriendlyName
                                                    </CardTitle>
                                                    <CardBody Context="toggle">
                                                        @toggle.Description
                                                    </CardBody>
                                                    <CardFooter Context="toggle">
                                                        <button type="button"
                                                                class="btn btn-primary"
                                                                style="width: 100%;"
                                                                disabled="@(isExcludedToggle(@toggle.Type) || isSelectedToggle(@toggle.Type))"
                                                                @onclick="@(() => SelectToggle(@toggle.Type))">
                                                                    @if (isExcludedToggle(@toggle.Type))
                                                                    {
                                                                        <span>Not Available</span>
                                                                    }
                                                                    else if (isSelectedToggle(@toggle.Type))
                                                                    {
                                                                        <span>Selected</span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span>Select</span>
                                                                    }
                                                        </button>
                                                    </CardFooter>
                                                </SingleCards>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>
                @if (selectedToggle == null)
                {
                    <div class="col-md-12 col-lg-6 text-center v-center right-arrow-container">
                        <h3 class="right-arrow placeholder">Start by selecting a toggle!</h3>
                    </div>
                }
                else
                {
                    <div class="col-md-12 col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                @selectedToggle.FriendlyName
                                <button type="button" class="btn btn-primary btn-shadow float-right" @onclick="AddToggle">
                                    Add Toggle
                                </button>
                            </div>
                            <div class="card-body">
                                @if (revealedToggle != null)
                                {
                                    <form role="form">
                                        <div class="form-group">
                                            <label>Ring</label>
                                            <ProductRings ProductName="@ProductName" OnChange="OnRingChange" />
                                        </div>
                                        <fieldset>
                                            @for (int index = 0; index < revealedToggle.Parameters.Count; index++)
                                            {
                                                <ToggleParameter Parameter="MapParameter(index, revealedToggle.Parameters.ElementAt(index))"
                                                                 OnParameterChange="OnParameterChange" />
                                            }
                                        </fieldset>
                                    </form>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </section>
</PageTransition>

@code {
    [Parameter] public string ProductName { get; set; }
    [Parameter] public string FeatureName { get; set; }

    private string selectedRing;
    private string selectedAssembly;
    private IEnumerable<string> assemblies;
    private KnownTypesToggleResponse knownTypes;
    private RevealToggleResponse revealedToggle;
    private IEnumerable<ExcludedToggle> excludedToggles;
    private KnownTypesToggleDetailResponse selectedToggle;
    private IDictionary<string, ToggleParameterViewModel> parameters;

    private string ToggleSearch { get; set; }

    protected override async Task OnInitializedAsync()
    {
        esquioState.SetBreadcrumb(
            new BreadcrumbItemViewModel { Title = "Home", Link = "#" },
            new BreadcrumbItemViewModel { Title = "Products", Link = "products" },
            new BreadcrumbItemViewModel { Title = ProductName, Link = $"products/{ProductName}" },
            new BreadcrumbItemViewModel { Title = FeatureName, Link = $"products/{ProductName}/{FeatureName}" },
            new BreadcrumbItemViewModel { Title = "New Toggle" });

        knownTypes = await GetToggleKnownTypes();
        excludedToggles = await GetExcludedToggles();

        assemblies = knownTypes
            .Toggles
            .Select(t => t.Assembly)
            .Distinct()
            .OrderBy(a => a);

        SelectAssembly(assemblies.First());

        ResetState();
    }

    private void ResetState()
    {
        parameters = new Dictionary<string, ToggleParameterViewModel>();
    }

    private IEnumerable<string> FilterAssemblies(IEnumerable<string> assemblies)
        => assemblies.Where(assembly => !ToggleSearch.HasValue() || GetAssemblyToggles(assembly).Any());

    private IEnumerable<KnownTypesToggleDetailResponse> GetAssemblyToggles(string assembly)
    {
        var toggles = knownTypes.Toggles.Where(t => t.Assembly == assembly);

        return !ToggleSearch.HasValue()
            ? toggles
            : toggles.Where(t =>
                t.FriendlyName.ToLower().Contains(ToggleSearch.ToLower()) ||
                t.Description.ToLower().Contains(ToggleSearch.ToLower()));
    }

    private void SelectAssembly(string assembly)
    {
        selectedAssembly = assembly;
    }

    private async Task SelectToggle(string toggleType)
    {
        if (isExcludedToggle(toggleType) || selectedToggle != null && selectedToggle.Type == toggleType) return;

        selectedToggle = knownTypes.Toggles.Find(t => t.Type == toggleType);
        revealedToggle = null;
        revealedToggle = await esquioHttpClient.RevealToggle(selectedToggle.Type);

        ResetState();
    }

    private Task<KnownTypesToggleResponse> GetToggleKnownTypes()
    {
        return esquioHttpClient.GetToggleKnownTypes();
    }

    private async Task<IEnumerable<ExcludedToggle>> GetExcludedToggles()
    {
        var feature = await esquioHttpClient.GetFeatureDetails(ProductName, FeatureName);
        return feature.Toggles;
    }

    private bool isExcludedToggle(string type) => excludedToggles.Any(t => t.Type == type);

    private bool isSelectedToggle(string type) => selectedToggle != null && selectedToggle.Type.Equals(type);

    private void OnParameterChange(ToggleParameterViewModel parameter)
    {
        if (parameters.ContainsKey(parameter.Name))
        {
            parameters[parameter.Name] = parameter;
        }
        else
        {
            parameters.Add(parameter.Name, parameter);
        }
    }

    private async Task AddToggle()
    {
        var result = await esquioHttpClient.AddToggle(new AddToggleRequest
        {
            ProductName = ProductName,
            FeatureName = FeatureName,
            RingName = selectedRing,
            ToggleType = selectedToggle.Type,
            Parameters = parameters
                .Values
                .OrderBy(parameter => parameter.Order)
                .Select(parameter => new AddToggleRequestDetailParameter
                {
                    Name = parameter.Name,
                    Type = parameter.ClrType,
                    Value = parameter.Value
                })
                .ToList()
        });

        if (result)
        {
            navigation.NavigateTo($"products/{ProductName}/{FeatureName}");
            notifications.Success("Create Toggle", "Toggle successfully created!");
        }
        else
        {
            notifications.Error("Create Toggle", "Error creating the toggle");
        }
    }

    private ToggleParameterViewModel MapParameter(int order, RevealToggleParameterResponse parameter)
        => new ToggleParameterViewModel(parameter.Name, parameter.ClrType, description: parameter.Description, order: order);

    private void OnRingChange(string ring)
    {
        selectedRing = ring;
    }
}
