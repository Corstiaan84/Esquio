@page "/authentication/{action}"
@inject IAccessTokenProvider AuthenticationService

@inject NavigationManager Navigation
@inject SignOutSessionStateManager SignOutManager

@inject IPolicyBuilder policyBuilder;
@inject EsquioState state;


<RemoteAuthenticatorView Action="@Action" OnLogInSucceeded="IsUserAllowed">
</RemoteAuthenticatorView>

@code{
    [Parameter] public string Action { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (RemoteAuthenticationActions.IsAction(RemoteAuthenticationActions.LogIn, Action))
        {
            await EvaluateAuthorization(notAllowed: () =>
            {
                Navigation.NavigateTo("Forbidden");
            });
        }
    }

    async Task IsUserAllowed(RemoteAuthenticationState state)
    {
        await EvaluateAuthorization(notAllowed: () =>
         {
             state.ReturnUrl = "Forbidden";
         });
    }

    async Task EvaluateAuthorization(Action notAllowed)
    {
        var tokenResult = await AuthenticationService.RequestAccessToken();

        if (tokenResult.TryGetToken(out AccessToken accessToken))
        {
            var my = await GetCurrentUserProfile(accessToken);

            if (my != null)
            {
                Log.Warning($"The current user authorization is  Authorized:{my.IsAuthorized} with Role:{my.ActAs}");

                var policy = policyBuilder.Build(my);

                state.ClearState();

                state.SetPolicy(policy);
            }
            else
            {
                notAllowed();
            }
        }
        else
        {
            Navigation.NavigateTo(tokenResult.RedirectUrl);
        }
    }

    async Task<MyResponse> GetCurrentUserProfile(AccessToken token)
    {
        var httpClient = new HttpClient();
        httpClient.BaseAddress = new Uri(Navigation.BaseUri);
        httpClient.DefaultRequestHeaders.Add("Authorization", $"Bearer {token.Value}");

        try
        {
            return await httpClient.GetJsonAsync<MyResponse>("api/users/my");
        }
        catch (Exception)
        {
            return null;
        }
    }
}